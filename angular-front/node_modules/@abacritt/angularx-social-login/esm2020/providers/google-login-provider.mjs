import { BaseLoginProvider } from '../entities/base-login-provider';
import { SocialUser } from '../entities/social-user';
import { EventEmitter } from '@angular/core';
import { BehaviorSubject, filter, skip, take } from 'rxjs';
const defaultInitOptions = {
    oneTapEnabled: true,
};
export class GoogleLoginProvider extends BaseLoginProvider {
    constructor(clientId, initOptions) {
        super();
        this.clientId = clientId;
        this.initOptions = initOptions;
        this.changeUser = new EventEmitter();
        this._socialUser = new BehaviorSubject(null);
        this._accessToken = new BehaviorSubject(null);
        this._receivedAccessToken = new EventEmitter();
        this.initOptions = { ...defaultInitOptions, ...this.initOptions };
        // emit changeUser events but skip initial value from behaviorSubject
        this._socialUser.pipe(skip(1)).subscribe(this.changeUser);
        // emit receivedAccessToken but skip initial value from behaviorSubject
        this._accessToken.pipe(skip(1)).subscribe(this._receivedAccessToken);
    }
    initialize(autoLogin) {
        return new Promise((resolve, reject) => {
            try {
                this.loadScript(GoogleLoginProvider.PROVIDER_ID, 'https://accounts.google.com/gsi/client', () => {
                    google.accounts.id.initialize({
                        client_id: this.clientId,
                        auto_select: autoLogin,
                        callback: ({ credential }) => {
                            const socialUser = this.createSocialUser(credential);
                            this._socialUser.next(socialUser);
                        },
                        prompt_parent_id: this.initOptions?.prompt_parent_id,
                        itp_support: this.initOptions.oneTapEnabled
                    });
                    if (this.initOptions.oneTapEnabled) {
                        this._socialUser
                            .pipe(filter((user) => user === null))
                            .subscribe(() => google.accounts.id.prompt(console.debug));
                    }
                    if (this.initOptions.scopes) {
                        const scope = this.initOptions.scopes instanceof Array
                            ? this.initOptions.scopes.filter((s) => s).join(' ')
                            : this.initOptions.scopes;
                        this._tokenClient = google.accounts.oauth2.initTokenClient({
                            client_id: this.clientId,
                            scope,
                            prompt: this.initOptions.prompt,
                            callback: (tokenResponse) => {
                                if (tokenResponse.error) {
                                    this._accessToken.error({
                                        code: tokenResponse.error,
                                        description: tokenResponse.error_description,
                                        uri: tokenResponse.error_uri,
                                    });
                                }
                                else {
                                    this._accessToken.next(tokenResponse.access_token);
                                }
                            },
                        });
                    }
                    resolve();
                });
            }
            catch (err) {
                reject(err);
            }
        });
    }
    getLoginStatus() {
        return new Promise((resolve, reject) => {
            if (this._socialUser.value) {
                resolve(this._socialUser.value);
            }
            else {
                reject(`No user is currently logged in with ${GoogleLoginProvider.PROVIDER_ID}`);
            }
        });
    }
    refreshToken() {
        return new Promise((resolve, reject) => {
            google.accounts.id.revoke(this._socialUser.value.id, (response) => {
                if (response.error)
                    reject(response.error);
                else
                    resolve(this._socialUser.value);
            });
        });
    }
    getAccessToken() {
        return new Promise((resolve, reject) => {
            if (!this._tokenClient) {
                if (this._socialUser.value) {
                    reject('No token client was instantiated, you should specify some scopes.');
                }
                else {
                    reject('You should be logged-in first.');
                }
            }
            else {
                this._tokenClient.requestAccessToken({
                    hint: this._socialUser.value?.email,
                });
                this._receivedAccessToken.pipe(take(1)).subscribe(resolve);
            }
        });
    }
    revokeAccessToken() {
        return new Promise((resolve, reject) => {
            if (!this._tokenClient) {
                reject('No token client was instantiated, you should specify some scopes.');
            }
            else if (!this._accessToken.value) {
                reject('No access token to revoke');
            }
            else {
                google.accounts.oauth2.revoke(this._accessToken.value, () => {
                    this._accessToken.next(null);
                    resolve();
                });
            }
        });
    }
    signIn() {
        return Promise.reject('You should not call this method directly for Google, use "<asl-google-signin-button>" wrapper ' +
            'or generate the button yourself with "google.accounts.id.renderButton()" ' +
            '(https://developers.google.com/identity/gsi/web/guides/display-button#javascript)');
    }
    async signOut() {
        google.accounts.id.disableAutoSelect();
        this._socialUser.next(null);
    }
    createSocialUser(idToken) {
        const user = new SocialUser();
        user.idToken = idToken;
        const payload = this.decodeJwt(idToken);
        user.id = payload.sub;
        user.name = payload.name;
        user.email = payload.email;
        user.photoUrl = payload.picture;
        user.firstName = payload['given_name'];
        user.lastName = payload['family_name'];
        return user;
    }
    decodeJwt(idToken) {
        const base64Url = idToken.split(".")[1];
        const base64 = base64Url.replace(/-/g, "+").replace(/_/g, "/");
        const jsonPayload = decodeURIComponent(window.atob(base64)
            .split("")
            .map(function (c) {
            return "%" + ("00" + c.charCodeAt(0).toString(16)).slice(-2);
        })
            .join(""));
        return JSON.parse(jsonPayload);
    }
}
GoogleLoginProvider.PROVIDER_ID = 'GOOGLE';
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZ29vZ2xlLWxvZ2luLXByb3ZpZGVyLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vcHJvamVjdHMvbGliL3NyYy9wcm92aWRlcnMvZ29vZ2xlLWxvZ2luLXByb3ZpZGVyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxpQkFBaUIsRUFBRSxNQUFNLGlDQUFpQyxDQUFDO0FBQ3BFLE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSx5QkFBeUIsQ0FBQztBQUNyRCxPQUFPLEVBQUUsWUFBWSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQzdDLE9BQU8sRUFBRSxlQUFlLEVBQUUsTUFBTSxFQUFFLElBQUksRUFBRSxJQUFJLEVBQUUsTUFBTSxNQUFNLENBQUM7QUErQjNELE1BQU0sa0JBQWtCLEdBQXNCO0lBQzVDLGFBQWEsRUFBRSxJQUFJO0NBQ3BCLENBQUM7QUFFRixNQUFNLE9BQU8sbUJBQW9CLFNBQVEsaUJBQWlCO0lBVXhELFlBQ1UsUUFBZ0IsRUFDUCxXQUErQjtRQUVoRCxLQUFLLEVBQUUsQ0FBQztRQUhBLGFBQVEsR0FBUixRQUFRLENBQVE7UUFDUCxnQkFBVyxHQUFYLFdBQVcsQ0FBb0I7UUFUbEMsZUFBVSxHQUFHLElBQUksWUFBWSxFQUFxQixDQUFDO1FBRWxELGdCQUFXLEdBQUcsSUFBSSxlQUFlLENBQW9CLElBQUksQ0FBQyxDQUFDO1FBQzNELGlCQUFZLEdBQUcsSUFBSSxlQUFlLENBQWdCLElBQUksQ0FBQyxDQUFDO1FBQ3hELHlCQUFvQixHQUFHLElBQUksWUFBWSxFQUFVLENBQUM7UUFTakUsSUFBSSxDQUFDLFdBQVcsR0FBRyxFQUFFLEdBQUcsa0JBQWtCLEVBQUUsR0FBRyxJQUFJLENBQUMsV0FBVyxFQUFFLENBQUM7UUFFbEUscUVBQXFFO1FBQ3JFLElBQUksQ0FBQyxXQUFXLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLFNBQVMsQ0FBQyxJQUFJLENB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QUFJLENBQUMsRUFBRSxDQUFDLENBQ1osQ0FBQztRQUNGLE9BQU8sSUFBSSxDQUFDLEtBQUssQ0FBQyxXQUFXLENBQUMsQ0FBQztJQUNqQyxDQUFDOztBQWhMc0IsK0JBQVcsR0FBVyxRQUFRLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBCYXNlTG9naW5Qcm92aWRlciB9IGZyb20gJy4uL2VudGl0aWVzL2Jhc2UtbG9naW4tcHJvdmlkZXInO1xyXG5pbXBvcnQgeyBTb2NpYWxVc2VyIH0gZnJvbSAnLi4vZW50aXRpZXMvc29jaWFsLXVzZXInO1xyXG5pbXBvcnQgeyBFdmVudEVtaXR0ZXIgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcclxuaW1wb3J0IHsgQmVoYXZpb3JTdWJqZWN0LCBmaWx0ZXIsIHNraXAsIHRha2UgfSBmcm9tICdyeGpzJztcclxuXHJcbmV4cG9ydCBpbnRlcmZhY2UgR29vZ2xlSW5pdE9wdGlvbnMge1xyXG4gIC8qKlxyXG4gICAqIGVuYWJsZXMgdGhlIE9uZSBUYXAgbWVjaGFuaXNtLCBhbmQgbWFrZXMgYXV0by1sb2dpbiBwb3NzaWJsZVxyXG4gICAqL1xyXG4gIG9uZVRhcEVuYWJsZWQ/OiBib29sZWFuO1xyXG4gIC8qKlxyXG4gICAqIGxpc3Qgb2YgcGVybWlzc2lvbiBzY29wZXMgdG8gZ3JhbnQgaW4gY2FzZSB3ZSByZXF1ZXN0IGFuIGFjY2VzcyB0b2tlblxyXG4gICAqL1xyXG4gIHNjb3Blcz86IHN0cmluZyB8IHN0cmluZ1tdO1xyXG4gLyoqXHJcbiAgICogVGhpcyBhdHRyaWJ1dGUgc2V0cyB0aGUgRE9NIElEIG9mIHRoZSBjb250YWluZXIgZWxlbWVudC4gSWYgaXQncyBub3Qgc2V0LCB0aGUgT25lIFRhcCBwcm9tcHQgaXMgZGlzcGxheWVkIGluIHRoZSB0b3AtcmlnaHQgY29ybmVyIG9mIHRoZSB3aW5kb3cuXHJcbiAgICovXHJcbiAgcHJvbXB0X3BhcmVudF9pZD86IHN0cmluZztcclxuXHJcbiAgLyoqXHJcbiAgICogT3B0aW9uYWwsIGRlZmF1bHRzIHRvICdzZWxlY3RfYWNjb3VudCcuXHJcbiAgICogQSBzcGFjZS1kZWxpbWl0ZWQsIGNhc2Utc2Vuc2l0aXZlIGxpc3Qgb2YgcHJvbXB0cyB0byBwcmVzZW50IHRoZVxyXG4gICAqIHVzZXIuXHJcbiAgICogUG9zc2libGUgdmFsdWVzIGFyZTpcclxuICAgKiBlbXB0eSBzdHJpbmcgVGhlIHVzZXIgd2lsbCBiZSBwcm9tcHRlZCBvbmx5IHRoZSBmaXJzdCB0aW1lIHlvdXJcclxuICAgKiAgICAgYXBwIHJlcXVlc3RzIGFjY2Vzcy4gQ2Fubm90IGJlIHNwZWNpZmllZCB3aXRoIG90aGVyIHZhbHVlcy5cclxuICAgKiAnbm9uZScgRG8gbm90IGRpc3BsYXkgYW55IGF1dGhlbnRpY2F0aW9uIG9yIGNvbnNlbnQgc2NyZWVucy4gTXVzdFxyXG4gICAqICAgICBub3QgYmUgc3BlY2lmaWVkIHdpdGggb3RoZXIgdmFsdWVzLlxyXG4gICAqICdjb25zZW50JyBQcm9tcHQgdGhlIHVzZXIgZm9yIGNvbnNlbnQuXHJcbiAgICogJ3NlbGVjdF9hY2NvdW50JyBQcm9tcHQgdGhlIHVzZXIgdG8gc2VsZWN0IGFuIGFjY291bnQuXHJcbiAgICovXHJcbiAgcHJvbXB0PyA6ICcnIHwgJ25vbmUnIHwgJ2NvbnNlbnQnIHwgJ3NlbGVjdF9hY2NvdW50JztcclxufVxyXG5cclxuY29uc3QgZGVmYXVsdEluaXRPcHRpb25zOiBHb29nbGVJbml0T3B0aW9ucyA9IHtcclxuICBvbmVUYXBFbmFibGVkOiB0cnVlLFxyXG59O1xyXG5cclxuZXhwb3J0IGNsYXNzIEdvb2dsZUxvZ2luUHJvdmlkZXIgZXh0ZW5kcyBCYXNlTG9naW5Qcm92aWRlciB7XHJcbiAgcHVibGljIHN0YXRpYyByZWFkb25seSBQUk9WSURFUl9JRDogc3RyaW5nID0gJ0dPT0dMRSc7XHJcblxyXG4gIHB1YmxpYyByZWFkb25seSBjaGFuZ2VVc2VyID0gbmV3IEV2ZW50RW1pdHRlcjxTb2NpYWxVc2VyIHwgbnVsbD4oKTtcclxuXHJcbiAgcHJpdmF0ZSByZWFkb25seSBfc29jaWFsVXNlciA9IG5ldyBCZWhhdmlvclN1YmplY3Q8U29jaWFsVXNlciB8IG51bGw+KG51bGwpO1xyXG4gIHByaXZhdGUgcmVhZG9ubHkgX2FjY2Vzc1Rva2VuID0gbmV3IEJlaGF2aW9yU3ViamVjdDxzdHJpbmcgfCBudWxsPihudWxsKTtcclxuICBwcml2YXRlIHJlYWRvbmx5IF9yZWNlaXZlZEFjY2Vzc1Rva2VuID0gbmV3IEV2ZW50RW1pdHRlcjxzdHJpbmc+KCk7XHJcbiAgcHJpdmF0ZSBfdG9rZW5DbGllbnQ6IGdvb2dsZS5hY2NvdW50cy5vYXV0aDIuVG9rZW5DbGllbnQgfCB1bmRlZmluZWQ7XHJcblxyXG4gIGNvbnN0cnVjdG9yKFxyXG4gICAgcHJpdmF0ZSBjbGllbnRJZDogc3RyaW5nLFxyXG4gICAgcHJpdmF0ZSByZWFkb25seSBpbml0T3B0aW9ucz86IEdvb2dsZUluaXRPcHRpb25zXHJcbiAgKSB7XHJcbiAgICBzdXBlcigpO1xyXG5cclxuICAgIHRoaXMuaW5pdE9wdGlvbnMgPSB7IC4uLmRlZmF1bHRJbml0T3B0aW9ucywgLi4udGhpcy5pbml0T3B0aW9ucyB9O1xyXG5cclxuICAgIC8vIGVtaXQgY2hhbmdlVXNlciBldmVudHMgYnV0IHNraXAgaW5pdGlhbCB2YWx1ZSBmcm9tIGJlaGF2aW9yU3ViamVjdFxyXG4gICAgdGhpcy5fc29jaWFsVXNlci5waXBlKHNraXAoMSkpLnN1YnNjcmliZSh0aGlzLmNoYW5nZVVzZXIpO1xyXG5cclxuICAgIC8vIGVtaXQgcmVjZWl2ZWRBY2Nlc3NUb2tlbiBidXQgc2tpcCBpbml0aWFsIHZhbHVlIGZyb20gYmVoYXZpb3JTdWJqZWN0XHJcbiAgICB0aGlzLl9hY2Nlc3NUb2tlbi5waXBlKHNraXAoMSkpLnN1YnNjcmliZSh0aGlzLl9yZWNlaXZlZEFjY2Vzc1Rva2VuKTtcclxuICB9XHJcblxyXG4gIGluaXRpYWxpemUoYXV0b0xvZ2luPzogYm9vbGVhbik6IFByb21pc2U8dm9pZD4ge1xyXG4gICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcclxuICAgICAgdHJ5IHtcclxuICAgICAgICB0aGlzLmxvYWRTY3JpcHQoXHJcbiAgICAgICAgICBHb29nbGVMb2dpblByb3ZpZGVyLlBST1ZJREVSX0lELFxyXG4gICAgICAgICAgJ2h0dHBzOi8vYWNjb3VudHMuZ29vZ2xlLmNvbS9nc2kvY2xpZW50JyxcclxuICAgICAgICAgICgpID0+IHtcclxuICAgICAgICAgICAgZ29vZ2xlLmFjY291bnRzLmlkLmluaXRpYWxpemUoe1xyXG4gICAgICAgICAgICAgIGNsaWVudF9pZDogdGhpcy5jbGllbnRJZCxcclxuICAgICAgICAgICAgICBhdXRvX3NlbGVjdDogYXV0b0xvZ2luLFxyXG4gICAgICAgICAgICAgIGNhbGxiYWNrOiAoeyBjcmVkZW50aWFsIH0pID0+IHtcclxuICAgICAgICAgICAgICAgIGNvbnN0IHNvY2lhbFVzZXIgPSB0aGlzLmNyZWF0ZVNvY2lhbFVzZXIoY3JlZGVudGlhbCk7XHJcbiAgICAgICAgICAgICAgICB0aGlzLl9zb2NpYWxVc2VyLm5leHQoc29jaWFsVXNlcik7XHJcbiAgICAgICAgICAgICAgfSxcclxuICAgICAgICAgICAgICBwcm9tcHRfcGFyZW50X2lkOiB0aGlzLmluaXRPcHRpb25zPy5wcm9tcHRfcGFyZW50X2lkLFxyXG4gICAgICAgICAgICAgIGl0cF9zdXBwb3J0OiB0aGlzLmluaXRPcHRpb25zLm9uZVRhcEVuYWJsZWRcclxuICAgICAgICAgICAgfSk7XHJcblxyXG4gICAgICAgICAgICBpZiAodGhpcy5pbml0T3B0aW9ucy5vbmVUYXBFbmFibGVkKSB7XHJcbiAgICAgICAgICAgICAgdGhpcy5fc29jaWFsVXNlclxyXG4gICAgICAgICAgICAgICAgLnBpcGUoZmlsdGVyKCh1c2VyKSA9PiB1c2VyID09PSBudWxsKSlcclxuICAgICAgICAgICAgICAgIC5zdWJzY3JpYmUoKCkgPT4gZ29vZ2xlLmFjY291bnRzLmlkLnByb21wdChjb25zb2xlLmRlYnVnKSk7XHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgIGlmICh0aGlzLmluaXRPcHRpb25zLnNjb3Blcykge1xyXG4gICAgICAgICAgICAgIGNvbnN0IHNjb3BlID1cclxuICAgICAgICAgICAgICAgIHRoaXMuaW5pdE9wdGlvbnMuc2NvcGVzIGluc3RhbmNlb2YgQXJyYXlcclxuICAgICAgICAgICAgICAgICAgPyB0aGlzLmluaXRPcHRpb25zLnNjb3Blcy5maWx0ZXIoKHMpID0+IHMpLmpvaW4oJyAnKVxyXG4gICAgICAgICAgICAgICAgICA6IHRoaXMuaW5pdE9wdGlvbnMuc2NvcGVzO1xyXG5cclxuICAgICAgICAgICAgICB0aGlzLl90b2tlbkNsaWVudCA9IGdvb2dsZS5hY2NvdW50cy5vYXV0aDIuaW5pdFRva2VuQ2xpZW50KHtcclxuICAgICAgICAgICAgICAgIGNsaWVudF9pZDogdGhpcy5jbGllbnRJZCxcclxuICAgICAgICAgICAgICAgIHNjb3BlLFxyXG4gICAgICAgICAgICAgICAgcHJvbXB0IDogdGhpcy5pbml0T3B0aW9ucy5wcm9tcHQsXHJcbiAgICAgICAgICAgICAgICBjYWxsYmFjazogKHRva2VuUmVzcG9uc2UpID0+IHtcclxuICAgICAgICAgICAgICAgICAgaWYgKHRva2VuUmVzcG9uc2UuZXJyb3IpIHtcclxuICAgICAgICAgICAgICAgICAgICB0aGlzLl9hY2Nlc3NUb2tlbi5lcnJvcih7XHJcbiAgICAgICAgICAgICAgICAgICAgICBjb2RlOiB0b2tlblJlc3BvbnNlLmVycm9yLFxyXG4gICAgICAgICAgICAgICAgICAgICAgZGVzY3JpcHRpb246IHRva2VuUmVzcG9uc2UuZXJyb3JfZGVzY3JpcHRpb24sXHJcbiAgICAgICAgICAgICAgICAgICAgICB1cmk6IHRva2VuUmVzcG9uc2UuZXJyb3JfdXJpLFxyXG4gICAgICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMuX2FjY2Vzc1Rva2VuLm5leHQodG9rZW5SZXNwb25zZS5hY2Nlc3NfdG9rZW4pO1xyXG4gICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB9LFxyXG4gICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICByZXNvbHZlKCk7XHJcbiAgICAgICAgICB9XHJcbiAgICAgICAgKTtcclxuICAgICAgfSBjYXRjaCAoZXJyKSB7XHJcbiAgICAgICAgcmVqZWN0KGVycik7XHJcbiAgICAgIH1cclxuICAgIH0pO1xyXG4gIH1cclxuXHJcbiAgZ2V0TG9naW5TdGF0dXMoKTogUHJvbWlzZTxTb2NpYWxVc2VyPiB7XHJcbiAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xyXG4gICAgICBpZiAodGhpcy5fc29jaWFsVXNlci52YWx1ZSkge1xyXG4gICAgICAgIHJlc29sdmUodGhpcy5fc29jaWFsVXNlci52YWx1ZSk7XHJcbiAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgcmVqZWN0KFxyXG4gICAgICAgICAgYE5vIHVzZXIgaXMgY3VycmVudGx5IGxvZ2dlZCBpbiB3aXRoICR7R29vZ2xlTG9naW5Qcm92aWRlci5QUk9WSURFUl9JRH1gXHJcbiAgICAgICAgKTtcclxuICAgICAgfVxyXG4gICAgfSk7XHJcbiAgfVxyXG5cclxuICByZWZyZXNoVG9rZW4oKTogUHJvbWlzZTxTb2NpYWxVc2VyIHwgbnVsbD4ge1xyXG4gICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcclxuICAgICAgZ29vZ2xlLmFjY291bnRzLmlkLnJldm9rZSh0aGlzLl9zb2NpYWxVc2VyLnZhbHVlLmlkLCAocmVzcG9uc2UpID0+IHtcclxuICAgICAgICBpZiAocmVzcG9uc2UuZXJyb3IpIHJlamVjdChyZXNwb25zZS5lcnJvcik7XHJcbiAgICAgICAgZWxzZSByZXNvbHZlKHRoaXMuX3NvY2lhbFVzZXIudmFsdWUpO1xyXG4gICAgICB9KTtcclxuICAgIH0pO1xyXG4gIH1cclxuXHJcbiAgZ2V0QWNjZXNzVG9rZW4oKTogUHJvbWlzZTxzdHJpbmc+IHtcclxuICAgIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XHJcbiAgICAgIGlmICghdGhpcy5fdG9rZW5DbGllbnQpIHtcclxuICAgICAgICBpZiAodGhpcy5fc29jaWFsVXNlci52YWx1ZSkge1xyXG4gICAgICAgICAgcmVqZWN0KFxyXG4gICAgICAgICAgICAnTm8gdG9rZW4gY2xpZW50IHdhcyBpbnN0YW50aWF0ZWQsIHlvdSBzaG91bGQgc3BlY2lmeSBzb21lIHNjb3Blcy4nXHJcbiAgICAgICAgICApO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICByZWplY3QoJ1lvdSBzaG91bGQgYmUgbG9nZ2VkLWluIGZpcnN0LicpO1xyXG4gICAgICAgIH1cclxuICAgICAgfSBlbHNlIHtcclxuICAgICAgICB0aGlzLl90b2tlbkNsaWVudC5yZXF1ZXN0QWNjZXNzVG9rZW4oe1xyXG4gICAgICAgICAgaGludDogdGhpcy5fc29jaWFsVXNlci52YWx1ZT8uZW1haWwsXHJcbiAgICAgICAgfSk7XHJcbiAgICAgICAgdGhpcy5fcmVjZWl2ZWRBY2Nlc3NUb2tlbi5waXBlKHRha2UoMSkpLnN1YnNjcmliZShyZXNvbHZlKTtcclxuICAgICAgfVxyXG4gICAgfSk7XHJcbiAgfVxyXG5cclxuICByZXZva2VBY2Nlc3NUb2tlbigpOiBQcm9taXNlPHZvaWQ+IHtcclxuICAgIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XHJcbiAgICAgIGlmICghdGhpcy5fdG9rZW5DbGllbnQpIHtcclxuICAgICAgICByZWplY3QoXHJcbiAgICAgICAgICAnTm8gdG9rZW4gY2xpZW50IHdhcyBpbnN0YW50aWF0ZWQsIHlvdSBzaG91bGQgc3BlY2lmeSBzb21lIHNjb3Blcy4nXHJcbiAgICAgICAgKTtcclxuICAgICAgfSBlbHNlIGlmICghdGhpcy5fYWNjZXNzVG9rZW4udmFsdWUpIHtcclxuICAgICAgICByZWplY3QoJ05vIGFjY2VzcyB0b2tlbiB0byByZXZva2UnKTtcclxuICAgICAgfSBlbHNlIHtcclxuICAgICAgICBnb29nbGUuYWNjb3VudHMub2F1dGgyLnJldm9rZSh0aGlzLl9hY2Nlc3NUb2tlbi52YWx1ZSwgKCkgPT4ge1xyXG4gICAgICAgICAgdGhpcy5fYWNjZXNzVG9rZW4ubmV4dChudWxsKTtcclxuICAgICAgICAgIHJlc29sdmUoKTtcclxuICAgICAgICB9KTtcclxuICAgICAgfVxyXG4gICAgfSk7XHJcbiAgfVxyXG5cclxuICBzaWduSW4oKTogUHJvbWlzZTxTb2NpYWxVc2VyPiB7XHJcbiAgICByZXR1cm4gUHJvbWlzZS5yZWplY3QoXHJcbiAgICAgICdZb3Ugc2hvdWxkIG5vdCBjYWxsIHRoaXMgbWV0aG9kIGRpcmVjdGx5IGZvciBHb29nbGUsIHVzZSBcIjxhc2wtZ29vZ2xlLXNpZ25pbi1idXR0b24+XCIgd3JhcHBlciAnICtcclxuICAgICAgICAnb3IgZ2VuZXJhdGUgdGhlIGJ1dHRvbiB5b3Vyc2VsZiB3aXRoIFwiZ29vZ2xlLmFjY291bnRzLmlkLnJlbmRlckJ1dHRvbigpXCIgJyArXHJcbiAgICAgICAgJyhodHRwczovL2RldmVsb3BlcnMuZ29vZ2xlLmNvbS9pZGVudGl0eS9nc2kvd2ViL2d1aWRlcy9kaXNwbGF5LWJ1dHRvbiNqYXZhc2NyaXB0KSdcclxuICAgICk7XHJcbiAgfVxyXG5cclxuICBhc3luYyBzaWduT3V0KCk6IFByb21pc2U8dm9pZD4ge1xyXG4gICAgZ29vZ2xlLmFjY291bnRzLmlkLmRpc2FibGVBdXRvU2VsZWN0KCk7XHJcbiAgICB0aGlzLl9zb2NpYWxVc2VyLm5leHQobnVsbCk7XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIGNyZWF0ZVNvY2lhbFVzZXIoaWRUb2tlbjogc3RyaW5nKSB7XHJcbiAgICBjb25zdCB1c2VyID0gbmV3IFNvY2lhbFVzZXIoKTtcclxuICAgIHVzZXIuaWRUb2tlbiA9IGlkVG9rZW47XHJcbiAgICBjb25zdCBwYXlsb2FkID0gdGhpcy5kZWNvZGVKd3QoaWRUb2tlbik7XHJcbiAgICB1c2VyLmlkID0gcGF5bG9hZC5zdWI7XHJcbiAgICB1c2VyLm5hbWUgPSBwYXlsb2FkLm5hbWU7XHJcbiAgICB1c2VyLmVtYWlsID0gcGF5bG9hZC5lbWFpbDtcclxuICAgIHVzZXIucGhvdG9VcmwgPSBwYXlsb2FkLnBpY3R1cmU7XHJcbiAgICB1c2VyLmZpcnN0TmFtZSA9IHBheWxvYWRbJ2dpdmVuX25hbWUnXTtcclxuICAgIHVzZXIubGFzdE5hbWUgPSBwYXlsb2FkWydmYW1pbHlfbmFtZSddO1xyXG4gICAgcmV0dXJuIHVzZXI7XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIGRlY29kZUp3dChpZFRva2VuOiBzdHJpbmcpOiBSZWNvcmQ8c3RyaW5nLCBzdHJpbmcgfCB1bmRlZmluZWQ+IHtcclxuICAgIGNvbnN0IGJhc2U2NFVybCA9IGlkVG9rZW4uc3BsaXQoXCIuXCIpWzFdO1xyXG4gICAgY29uc3QgYmFzZTY0ID0gYmFzZTY0VXJsLnJlcGxhY2UoLy0vZywgXCIrXCIpLnJlcGxhY2UoL18vZywgXCIvXCIpO1xyXG4gICAgY29uc3QganNvblBheWxvYWQgPSBkZWNvZGVVUklDb21wb25lbnQoXHJcbiAgICAgIHdpbmRvdy5hdG9iKGJhc2U2NClcclxuICAgICAgICAuc3BsaXQoXCJcIilcclxuICAgICAgICAubWFwKGZ1bmN0aW9uIChjKSB7XHJcbiAgICAgICAgICByZXR1cm4gXCIlXCIgKyAoXCIwMFwiICsgYy5jaGFyQ29kZUF0KDApLnRvU3RyaW5nKDE2KSkuc2xpY2UoLTIpO1xyXG4gICAgICAgIH0pXHJcbiAgICAgICAgLmpvaW4oXCJcIilcclxuICAgICk7XHJcbiAgICByZXR1cm4gSlNPTi5wYXJzZShqc29uUGF5bG9hZCk7XHJcbiAgfVxyXG59XHJcbiJdfQ==